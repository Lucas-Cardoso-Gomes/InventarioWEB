@{
    ViewData["Title"] = "Acesso Remoto";
}

<div class="text-center">
    <h1 class="display-4">Acesso Remoto a @ViewBag.Ip</h1>
    <img id="screen" src="" class="img-fluid" />
</div>

@section Scripts {
    <script>
        const ip = "@ViewBag.Ip";
        const screen = document.getElementById("screen");
        let currentBlobUrl = null;

        function getScreen() {
            fetch(`/RemoteAccess/GetScreenStream?ip=${ip}`)
                .then(response => {
                    if (!response.ok) {
                        console.error("Erro ao buscar imagem:", response.status, response.statusText);
                        // Tenta novamente após um tempo maior em caso de erro
                        setTimeout(getScreen, 1000);
                        return;
                    }
                    return response.blob();
                })
                .then(blob => {
                    if (blob && blob.size > 0) {
                        // Limpa o blob anterior para evitar vazamento de memória
                        if (currentBlobUrl) {
                            URL.revokeObjectURL(currentBlobUrl);
                        }
                        currentBlobUrl = URL.createObjectURL(blob);
                        screen.src = currentBlobUrl;
                    } else {
                        console.warn("Recebido um blob vazio ou inválido.");
                    }
                    // Chama a função novamente após um intervalo
                    setTimeout(getScreen, 250);
                })
                .catch(error => {
                    console.error("Falha na requisição de fetch:", error);
                    // Tenta novamente após um tempo maior em caso de falha de rede
                    setTimeout(getScreen, 1000);
                });
        }

        screen.addEventListener("click", function (e) {
            const rect = screen.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            fetch(`/RemoteAccess/SendMouse?ip=${ip}&x=${x}&y=${y}&type=click`, { method: "POST" });
        });

        document.addEventListener("keydown", function (e) {
            fetch(`/RemoteAccess/SendKeyboard?ip=${ip}&key=${e.key}`, { method: "POST" });
        });

        getScreen();
    </script>
}
